# ===========================================================================
# Warp Parse - Flow Data Processing System
# ===========================================================================
#
# Binary applications for data parsing and processing:
#   - wparse:   主解析引擎
#   - wpgen:    规则生成工具
#   - wproj:    项目管理工具
#   - wprescue: 数据恢复工具
#
# Feature flags:
#   - default/community: 社区版（含 Kafka、MySQL、ClickHouse 等）
#   - runtime-core:      最小运行时
#
# ===========================================================================

[package]
name = "warp-parse"
version = "0.9.2"
edition = "2021"
rust-version = "1.75"
authors = ["Warp Parse Team"]
license = "Apache-2.0"
description = "High-performance flow data parsing and processing system"
repository = "https://github.com/wp-labs/warp-parse"
keywords = ["parsing", "data-processing", "security", "log-analysis"]
categories = ["command-line-utilities", "parsing"]

# ===========================================================================
# Binary Applications
# ===========================================================================

[[bin]]
name = "wparse"
path = "src/wparse/main.rs"

[[bin]]
name = "wpgen"
path = "src/wpgen/main.rs"

[[bin]]
name = "wproj"
path = "src/wproj/main.rs"

[[bin]]
name = "wprescue"
path = "src/wprescue/main.rs"

# ===========================================================================
# Build Profiles
# ===========================================================================

[profile.release]
opt-level = 3
lto = "thin"
codegen-units = 1

[profile.dev]
opt-level = 0
debug = true

[profile.dev.package."*"]
opt-level = 2  # 依赖库使用优化编译加速运行

# ===========================================================================
# Dependencies
# ===========================================================================

[dependencies]
# --- System and Platform ---
sysinfo = "~0.33"
async-signal = "~0.2"
libc = "~0.2"
signal-hook-registry = "~1.4"
tikv-jemallocator = "~0.6"

# --- Async Runtime ---
tokio = { version = "~1.48", features = ["full"] }
tokio-util = { version = "~0.7", features = ["full"] }
tokio-async-drop = "~0.1"
futures-util = "~0.3"
futures-lite = "~2.3"
async-trait = "~0.1"
async-broadcast = "~0.6"

# --- Serialization ---
serde = { version = "~1.0", features = ["derive"] }
serde_json = "~1.0"
toml = "~0.8"

# --- Logging and Errors ---
log = "~0.4"
anyhow = "~1.0"
thiserror = "~2.0"
orion-error = "~0.5"
orion_conf = { version = "~0.3", features = ["yaml", "toml"] }

# --- Time ---
chrono = "~0.4"
time = "~0.3"

# --- CLI ---
clap = { version = "~4.5", features = ["derive"] }
comfy-table = "~7.2"

# --- Parsing ---
winnow = "~0.7"
#regex = "~1.11"
wildmatch = "~2.6"
strfmt = "~0.2"
syslog = "~6.0"

# --- Derive Macros ---
derive_more = { version = "~2.1", features = ["full"] }
derive_builder = "~0.20"
derive-getters = "~0.5"
enum_dispatch = "~0.3"
educe = { version = "~0.4", features = ["Debug", "Default"] }

# --- Utilities ---
#bytes = "~1.7"
uuid = { version = "~1.19", features = ["v4"] }
once_cell = "~1.21"
lazy_static = "~1.5"
contracts = "~0.6"
ctor = "~0.2"
hex = "~0.4"
shadow-rs = "~1.2"
rand = "0.9.2"

# --- Data Structures ---
lru = "~0.12"
ipnet = "~2.11"

# --- File System ---
walkdir = "~2.5"
glob = "~0.3"

# --- Testing (also in dependencies for mockall) ---

# --- Internal: Open API ---
wp_connector_api = { package = "wp-connector-api", git = "https://github.com/wp-labs/wp-open-api", tag = "v0.5.1-beta" }
wp_parse_api     = { package = "wp-parse-api",     git = "https://github.com/wp-labs/wp-open-api", tag = "v0.5.1-beta" }
wp_model_core    = { package = "wp-model-core",    git = "https://github.com/wp-labs/wp-open-api", tag = "v0.5.1-beta" }

# --- Internal: Infrastructure ---
wp-log       = { package = "wp-log",       git = "https://github.com/wp-labs/wp-infras", tag = "v0.5.10-beta" }
wp-error     = { package = "wp-error",     git = "https://github.com/wp-labs/wp-infras", tag = "v0.5.10-beta" }
wp-specs     = { package = "wp-specs",     git = "https://github.com/wp-labs/wp-infras", tag = "v0.5.10-beta" }
wp-conf-base = { package = "wp-conf-base", git = "https://github.com/wp-labs/wp-infras", tag = "v0.5.10-beta" }
wp-data-fmt  = { package = "wp-data-fmt",  git = "https://github.com/wp-labs/wp-infras", tag = "v0.5.10-beta" }

# --- Internal: Schema ---
#wp_schema = { package = "wp-schema", git = "https://cnb.cool/dy-sec/core-engine/data-parse/wp-schema.git", tag = "v0.1.3" }

# --- Internal: Engine ---
wp-engine     = {                            git = "https://github.com/wp-labs/wp-engine", tag = "v1.4.2-alpha" }
wpcnt_lib     = { package = "wp-cli-utils",  git = "https://github.com/wp-labs/wp-engine", tag = "v1.4.2-alpha" }
#orion_common  = { package = "orion_common",  git = "https://github.com/wp-labs/wp-engine", tag = "v1.4.2-alpha" }
wp_conf       = { package = "wp-config",     git = "https://github.com/wp-labs/wp-engine", tag = "v1.4.2-alpha" }
#wp_data_model = { package = "wp-data-model", git = "https://github.com/wp-labs/wp-engine", tag = "v1.4.2-alpha" }
wpl           = { package = "wp-lang",       git = "https://github.com/wp-labs/wp-engine", tag = "v1.4.2-alpha" }
wp_knowledge  = { package = "wp-knowledge",  git = "https://github.com/wp-labs/wp-engine", tag = "v1.4.2-alpha" }
wp-cli-core   = { package = "wp-cli-core",   git = "https://github.com/wp-labs/wp-engine", tag = "v1.4.2-alpha" }
wp-proj       = { package = "wp-proj",       git = "https://github.com/wp-labs/wp-engine", tag = "v1.4.2-alpha" }

# --- Internal: Enterprise (optional) ---

# --- Internal: Connectors ---
wp_connectors = { package = "wp-connectors", git = "https://github.com/wp-labs/wp-connectors.git", tag = "v0.5.6-alpha" }

# ===========================================================================
# Build Dependencies
# ===========================================================================

[build-dependencies]
shadow-rs = "~1.2"

# ===========================================================================
# Dev Dependencies
# ===========================================================================

[dev-dependencies]
serial_test = "~3.2"
httpmock = "~0.7"
collection_literals = "~1.0"
criterion = "~0.5"
tempfile = "~3.14"

# ===========================================================================
# Package Metadata
# ===========================================================================

[package.metadata.cargo-udeps.ignore]
normal = ["ctor"]

# ===========================================================================
# Features
# ===========================================================================

[features]
# --- Default ---
default = ["community"]

# --- Runtime ---
runtime-core = []

# --- Community Edition (default) ---
community = [
    "runtime-core",
    "kafka",
    "mysql",
    "clickhouse",
    "elasticsearch",
    "prometheus",
]

# --- Connectors (via wp_connectors) ---
kafka         = ["wp_connectors/kafka"]
mysql         = ["wp_connectors/mysql"]
clickhouse    = ["wp_connectors/clickhouse"]
elasticsearch = ["wp_connectors/elasticsearch"]
prometheus    = ["wp_connectors/prometheus"]

# --- Enterprise ---

# --- Convenience ---
all = ["community"]

# --- Testing (cfg gates) ---
sys_test        = []
res_depend_test = []

# --- Development ---
examples  = []
perf-ci   = []
dev-tools = []
wp-enterprise = []

# --- Plugins (placeholder for compatibility) ---
example-plugin = []
extras         = []
plugin-suite   = []

# ===========================================================================
# Local Development Patches (template)
# ===========================================================================
# Uncomment to use local paths instead of git dependencies:
#
# [patch."https://cnb.cool/dy-sec/core-engine/data-parse/wp-engine"]
# wp-engine     = { path = "../wp-engine" }
# wp-cli-utils  = { path = "../wp-engine/crates/wp-cli-utils" }
## orion_common  = { path = "../wp-engine/crates/orion_common" }
# wp-config     = { path = "../wp-engine/crates/wp-config" }
## wp-data-model = { path = "../wp-engine/crates/wp-data-model" }
# wp-lang       = { path = "../wp-engine/crates/wp-lang" }
# wp-knowledge  = { path = "../wp-engine/crates/wp-knowledge" }
# wp-cli-core   = { path = "../wp-engine/crates/wp-cli-core" }
# wp-proj       = { path = "../wp-engine/crates/wp-proj" }
#
# [patch."https://cnb.cool/dy-sec/core-engine/data-parse/wp-enterprise"]
# wp-enterprise = { path = "../wp-enterprise" }
